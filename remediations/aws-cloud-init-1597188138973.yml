---
# Red Hat Insights has recommended one or more actions for you, a system administrator, to review and if you
# deem appropriate, deploy on your systems running Red Hat software. Based on the analysis, we have automatically
# generated an Ansible Playbook for you. Please review and test the recommended actions and the Playbook as
# they may contain configuration changes, updates, reboots and/or other changes to your systems. Red Hat is not
# responsible for any adverse outcomes related to these recommendations or Playbooks.
#
# aws cloud-init
# https://cloud.redhat.com/insights/remediations/499f1b83-a1d7-45f6-bb2b-38be8dbaa620
# Generated by Red Hat Insights on Tue, 11 Aug 2020 23:22:18 GMT

# Misconfigured applications running on EC2 instances where IMDSv1 is enabled will have access to the internal Metadata service by exploiting application vulnerabilities
# Identifier: (advisor:aws_cloud_init_support_for_imdsv2|AWS_EC2_USING_IMDSV1,fix)
# Version: 31133ab7e69e61808da8368a1778589f586cd83b
- name: Update cloud-init package to 18.5-6 or above (RHEL7) and 19.4 or above (RHEL7.9 or later)
  hosts: "downgradedsniffle.ddns.net"
  become: true

  tasks:
    - when: ansible_distribution_major_version == "7"
      block:
        - name: Update cloud-init to the lastest version
          yum:
            name: cloud-init
            state: latest

    - when: ansible_distribution_major_version == "8"
      block:
        - name: Update cloud-init to the lastest version
          dnf:
            name: cloud-init
            state: latest

- name: run insights
  hosts: "downgradedsniffle.ddns.net"
  become: True
  gather_facts: False
  tasks:
    - name: run insights
      command: insights-client
      changed_when: false