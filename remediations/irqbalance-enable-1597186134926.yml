---
# Red Hat Insights has recommended one or more actions for you, a system administrator, to review and if you
# deem appropriate, deploy on your systems running Red Hat software. Based on the analysis, we have automatically
# generated an Ansible Playbook for you. Please review and test the recommended actions and the Playbook as
# they may contain configuration changes, updates, reboots and/or other changes to your systems. Red Hat is not
# responsible for any adverse outcomes related to these recommendations or Playbooks.
#
# irqbalance enable
# https://cloud.redhat.com/insights/remediations/e99f9190-c519-44f5-93af-a59a6010c1fe
# Generated by Red Hat Insights on Tue, 11 Aug 2020 22:48:54 GMT
# Created by zeb.carnell@ingrammicro.com

- name: run insights to obtain latest diagnosis info
  hosts: "rhel1"
  become: True
  tasks:
    - name: obtain diagnosis info
      shell: 'insights-client --diagnosis e99f9190-c519-44f5-93af-a59a6010c1fe'
      register: insights_result
      changed_when: false
      check_mode: false
    - name: register insights report as fact for use by other plays
      set_fact: insights_report={{ insights_result.stdout }}

# Decreased system performance occurs when not running the irqbalance service
# Identifier: (advisor:irqbalance_not_running|IRQBALANCE_NOT_RUNNING_OR_ENABLED,fix)
# Version: b3573d757ad89fe89932e30916c773b304ca46df
- name: Install, enable, start the irqbalance service
  hosts: "rhel1"
  become: true
  vars:
    pydata: "{{ insights_report.details['irqbalance_not_running|IRQBALANCE_NOT_RUNNING_OR_ENABLED'] }}"

  tasks:
  - when: pydata is defined
    block:
      - name: Install the irqbalance package
        yum:
          name: irqbalance
          state: latest
        when: pydata.irqbalance_installed is defined and not pydata.irqbalance_installed

      - name: Enable the irqbalance service
        service:
          name: irqbalance
          enabled: yes
        when: pydata.irqbalance_enabled is defined and not pydata.irqbalance_enabled

      - name: Start the irqbalance service
        service:
          name: irqbalance
          state: started
        when: pydata.irqbalance_running is defined and not pydata.irqbalance_running


- name: run insights
  hosts: "rhel1"
  become: True
  gather_facts: False
  tasks:
    - name: run insights
      command: insights-client
      changed_when: false